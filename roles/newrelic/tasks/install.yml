---
- name: add gpg key
  apt_key: >
    id=548C16BF
    state=present
    url="https://download.newrelic.com/548C16BF.gpg"

- name: add repository
  apt_repository: >
    repo="deb http://apt.newrelic.com/debian/ newrelic non-free"
    state=present
    update_cache=yes

- name: install service
  apt: >
    force=yes
    pkg=newrelic-sysmond
    state=present
  notify: restart newrelic

# it must be there, because: "Can not start the New Relic Server Monitor until you insert a valid license key"
- name: set licence key
  lineinfile: >
    dest=/etc/newrelic/nrsysmond.cfg
    line="license_key={{ newrelic_licence_key }}"
    regexp=^license_key=
    state=present
  notify: restart newrelic
  when: newrelic_licence_key != false

- name: ensure a service is enabled and running
  service: >
    enabled=yes
    name=newrelic-sysmond
    state=started

- name: enable modules
  apt: >
    force=yes
    pkg="{{ item }}"
    state=present
  notify: restart newrelic-apache
  with_items: newrelic_modules
