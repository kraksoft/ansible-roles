---
- name: create users
  user: >
    createhome=yes
    generate_ssh_key=yes
    name={{ item.name }}
    shell=/bin/bash
    state=present
  with_items: ssh_users

- name: add authorized keys
  authorized_key: >
    key="{{ lookup('file', ssh_keys_path + item.1) }}"
    state=present
    user={{ item.0.name }}
  with_subelements:
    - ssh_users
    - keys

- name: prepare environment with files
  copy: >
    dest="/home/{{ item.0.name }}"
    group="{{ item.0.name }}"
    mode="0644"
    owner="{{ item.0.name }}"
    src="{{ ssh_files_path }}{{ item.1 }}"
  with_nested:
    - ssh_users
    - ssh_files
